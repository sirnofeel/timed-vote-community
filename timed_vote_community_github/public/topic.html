
<!DOCTYPE html>
<html lang="ko">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width,initial-scale=1">
<title>ì£¼ì œ ìƒì„¸</title>
<link rel="stylesheet" href="/style.css">
</head>
<body>
<header class="top">
  <div class="brand">ğŸ—³ï¸ ì£¼ì œ ìƒì„¸</div>
  <nav><a href="/" class="btn ghost">ëª©ë¡</a></nav>
</header>

<main class="container">
  <div id="card" class="card"></div>
</main>

<script>
async function ensureAuth(){ const me = await fetch('/api/auth/me'); if (!me.ok) location.href='/login.html'; }
ensureAuth();

const id = location.pathname.split('/').pop();
let topic;

async function load() {
  const res = await fetch(`/api/topics/${id}`);
  const data = await res.json();
  if (!res.ok) { document.getElementById('card').innerHTML = '<p>ì£¼ì œë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.</p>'; return; }
  topic = data.topic;
  render();
}
function render() {
  const closed = topic.status === 'closed';
  const deadline = new Date(topic.deadline);
  const revealAt = new Date(topic.revealAt);
  const now = new Date();
  const revealed = topic.results != null;
  const leftMs = deadline - now;
  const leftRevealMs = revealAt - now;

  let html = `
    <h2>${escapeHtml(topic.title)}</h2>
    ${topic.desc ? `<p class="muted">${escapeHtml(topic.desc)}</p>`: ''}
    <div class="row small">
      <span>ë§ˆê°: ${deadline.toLocaleString()}</span>
      <span>ê²°ê³¼ ê³µê°œ: ${revealAt.toLocaleString()}</span>
      <span class="badge ${closed?'closed':'open'}">${closed?'ë§ˆê°':'ì§„í–‰ì¤‘'}</span>
      ${!revealed && closed ? '<span class="badge wait">ê³µê°œ ëŒ€ê¸°ì¤‘</span>': ''}
    </div>
  `;

  if (!closed) {
    html += `<div class="countdown">â³ ë‚¨ì€ ì‹œê°„: <b id="left">ê³„ì‚°ì¤‘...</b></div>`;
    html += `<div class="options">` +
      topic.options.map((o, i) => `<button class="btn option" data-i="${i}">${escapeHtml(o.text)}</button>`).join('') +
      `</div>` +
      `<div class="muted small">í•œ ë²ˆë§Œ íˆ¬í‘œí•  ìˆ˜ ìˆìŠµë‹ˆë‹¤. ê²°ê³¼ëŠ” ë§ˆê° <b>10ë¶„ í›„</b> ê³µê°œë©ë‹ˆë‹¤.</div>`;
  } else if (!revealed) {
    html += `<div class="countdown">â³ ê²°ê³¼ ê³µê°œê¹Œì§€: <b id="leftReveal">ê³„ì‚°ì¤‘...</b></div>`;
    html += `<div class="muted small">ë§ˆê°ë˜ì—ˆìŠµë‹ˆë‹¤. ê²°ê³¼ëŠ” ê³µê°œ ì‹œê°„ì— ìë™ìœ¼ë¡œ í‘œì‹œë©ë‹ˆë‹¤.</div>`;
  } else {
    html += `<h3>ê²°ê³¼</h3>`;
    const total = topic.results.reduce((a,b)=>a+b,0) || 1;
    html += `<div class="bars">` +
      topic.options.map((o,i) => {
        const v = topic.results[i];
        const pct = Math.round(v*100/total);
        return `<div class="bar"><div class="barLabel">${escapeHtml(o.text)} <span>${v}í‘œ (${pct}%)</span></div><div class="barFill" style="width:${pct}%"></div></div>`;
      }).join('') +
      `</div>` +
      `<div class="muted small">ì´ íˆ¬í‘œìˆ˜: ${total}</div>`;
  }
  document.getElementById('card').innerHTML = html;

  if (!closed) {
    document.querySelectorAll('.option').forEach(b => b.onclick = vote);
    tick(deadline, 'left', () => load());
  } else if (!revealed) {
    tick(revealAt, 'leftReveal', () => load());
  }
}
async function vote(e) {
  const i = Number(e.currentTarget.dataset.i);
  const res = await fetch(`/api/topics/${id}/vote`, { method:'POST', headers:{'Content-Type':'application/json'}, body: JSON.stringify({ option: i }) });
  const data = await res.json();
  if (!res.ok) { alert(data.error||'ì˜¤ë¥˜'); return; }
  alert('íˆ¬í‘œ ì™„ë£Œ! ê²°ê³¼ëŠ” ë§ˆê° 10ë¶„ í›„ ê³µê°œë©ë‹ˆë‹¤.');
  load();
}
function escapeHtml(s){ return s?.replace(/[&<>"']/g, m => ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#039;'}[m])) }

function tick(targetDate, elId, onDone){
  function fmt(ms){
    if (ms<=0) return '00:00:00';
    const s = Math.floor(ms/1000);
    const h = String(Math.floor(s/3600)).padStart(2,'0');
    const m = String(Math.floor((s%3600)/60)).padStart(2,'0');
    const sec = String(s%60).padStart(2,'0');
    return `${h}:${m}:${sec}`;
  }
  const timer = setInterval(() => {
    const left = targetDate - new Date();
    const el = document.getElementById(elId);
    if (el) el.textContent = fmt(left);
    if (left <= 0) { clearInterval(timer); onDone(); }
  }, 1000);
}

load();
</script>
</body>
</html>
